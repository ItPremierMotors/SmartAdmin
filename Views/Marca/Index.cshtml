@{
    ViewData["Title"] = "Administración de Marcas";
}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0"><i class="fas fa-tags me-2"></i>@ViewData["Title"]</h1>
        <button class="btn btn-primary" id="btnNuevo">
            <i class="fas fa-plus me-2"></i>Nueva Marca
        </button>
    </div>

    <div class="card">
        <div class="card-body">
            <div id="loading" class="text-center py-4">
                <div class="spinner-border text-primary"></div>
            </div>

            <table class="table table-hover d-none" id="tabla" style="width:100%">
                <thead class="table-light">
                    <tr>
                        <th>Codigo</th>
                        <th>Nombre</th>
                        <th>Pais de Origen</th>
                        <th>Marca Propia</th>
                       
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
@section Scripts {
<script>
    const URLS={
       getAll: '@Url.Action("GetAll")',
       getDetail: '@Url.Action("MarcaDetailPartial")',
       createPartial: '@Url.Action("CreatePartial")',
       editPartial: '@Url.Action("EditPartial")',
       deletePartial: '@Url.Action("DeletePartial")',
       create:'@Url.Action("Create")',
       edit:'@Url.Action("Edit")', 
       delete:'@Url.Action("Delete")',

    };
    let dataTable=null;
    $(document).ready(function(){
     inicializarDataTable();
     $('#btnNuevo').on('click', abrirModalCrear);
    }); 
    function inicializarDataTable() {
            dataTable = $('#tabla').DataTable({
               ajax: {
                   url: URLS.getAll,
                   dataSrc: function (res) {
                       $('#loading').addClass('d-none');
                       $('#tabla').removeClass('d-none');
                       return res.success ? (res.data || []) : [];
             }
           },
           columns: [
           {
               data: 'codigo',
               render: data => data || 'N/A'
           },
           { data: 'nombre' },
           {
               data: 'paisOrigen',
               render: data => data || 'N/A'
           },
           {
               data: 'esMarcaPropia',
                     render: data =>
                       data
                         ? '<span class="badge bg-success">Sí</span>'
                         : '<span class="badge bg-secondary">No</span>'
           },
           {
               data: 'marcaId',
               orderable: false,
               className: 'text-center',
               render: (data, type, row) => `
                   <div class="btn-group btn-group-sm">
                     <button class="btn btn-outline-info" onclick="AbrirModalDetail('${data}')"><i class="fas fa-eye"></i></button>
                     <button class="btn btn-outline-primary" onclick="abrirModalEditar('${data}')"><i class="fas fa-edit"></i></button>
                     <button class="btn btn-outline-danger" onclick="AbrirModalDelete('${data}')"><i class="fas fa-trash"></i></button>
                   </div>
               `
           }
           ],
           language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json' },
           pageLength: 10,
           lengthMenu: [5, 10, 25, 50],
           order: [[0, 'asc']]
           });
    }
    //funiones para recargar datatable
    function recargarTabla() {
        dataTable.ajax.reload(null, false);
    }
    //funciones para abrir modales
    function abrirModalCrear() {
            AppModal.open({
                title: '<i class="fas fa-tag me-2"></i>Nueva Marca',
                url: URLS.createPartial,
                size: 'lg'
            });
    }
    function AbrirModalDetail(id) {
      AppModal.open({
          title: '<i class="fas fa-eye me-2"></i>Detalle de Marca',
          url: URLS.getDetail ,
          data: { id: id },
          size: 'md'
      });
    }
    function abrirModalEditar(id) {
            AppModal.open({
                title: '<i class="fas fa-pencil me-2"></i>Editar Marca',
                url: URLS.editPartial,
                data: { id: id },
                size: 'lg'
            });
    }
    function AbrirModalDelete(id) {
            AppModal.open({
                title: '<i class="fas fa-trash me-2"></i>Eliminar Marca',
                url: URLS.deletePartial,
                data: { id: id },
                size: 'sm'
            });
    }
    //acciones por modal

    function guardarMarca(){
     const form = document.getElementById('formCrearMarca');
     const btn = document.getElementById('btnGuardarMarca');
    const btnOriginal = btn.innerHTML;
     // Validar formulario HTML5 + DataAnnotations
     if (!form.checkValidity()) {
         form.reportValidity();
         return;
     }
     const data = {
        codigo: $('#Codigo').val().trim(),
        nombre: $('#Nombre').val().trim(),
        paisOrigen: $('#PaisOrigen').val().trim(),
        esMarcaPropia: $('#EsMarcaPropia').is(':checked'),
        logoUrl: $('#LogoUrl').val().trim(),
        observaciones: $('#Observaciones').val().trim()
     };
     $.ajax({
        url:URLS.create ,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        beforeSend: function () {
            // Deshabilitar botón mientras procesa
            $(btn).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Guardando...');
        },
        success: function (response) {
            if (response.success) {
                AppModal.close();
                // Refrescar DataTable
                recargarTabla();
                // Notificación de éxito
                Toast.success(response.message);
            }
        },
        error: function (xhr) {
            var response = xhr.responseJSON;
            if (response && response.message) {
              Toast.error(response.message);
            } else {
              Toast.error('Error al guardar la marca');
            }
        },
        complete: function () {
            // Rehabilitar botón
           $(btn).prop('disabled', false).html(btnOriginal);
        }
      });
    }
    //
    //editar marca 
     function actualizarMarca(){
     const form = document.getElementById('formEditarMarca');
     const btn = document.getElementById('btnEditarMarca');
     const btnOriginal = btn.innerHTML;
     // Validar formulario HTML5 + DataAnnotations
     if (!form.checkValidity()) {
         form.reportValidity();
         return;
     }
     const data = {
        marcaId:$('#MarcaId').val(),
        codigo: $('#Codigo').val().trim(),
        nombre: $('#Nombre').val().trim(),
        paisOrigen: $('#PaisOrigen').val().trim(),
        esMarcaPropia: $('#EsMarcaPropia').is(':checked'),
        logoUrl: $('#LogoUrl').val().trim(),
        observaciones: $('#Observaciones').val().trim()
     };
     $.ajax({
        url:URLS.edit ,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        beforeSend: function () {
            // Deshabilitar botón mientras procesa
            $(btn).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Guardando...');
        },
        success: function (response) {
            if (response.success) {
                AppModal.close();
                // Refrescar DataTable
                recargarTabla();
                // Notificación de éxito
                Toast.success(response.message);
            }
        },
        error: function (xhr) {
            var response = xhr.responseJSON;
            if (response && response.message) {
              Toast.error(response.message);
            } else {
              Toast.error('Error al guardar la marca');
            }
        },
        complete: function () {
            // Rehabilitar botón
           $(btn).prop('disabled', false).html(btnOriginal);
        }
      });
    }
    //
    //ELIMINAR MARCA
      function confirmarEliminar() {
        const id =parseInt($('#deleteId').val());
        const btn = document.getElementById('btnEliminarMarca');
        const btnOriginal = btn.innerHTML;
            console.log('ID a eliminar:', id);
        $.ajax({
            url: URLS.delete,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify( id ),
            beforeSend: function () {
                // Deshabilitar botón mientras procesa
             $(btn).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Eliminando...');
            },
            success: function (response) {
                if (response.success) {
                    AppModal.close();
                    // Refrescar DataTable
                    recargarTabla();
                    // Notificación de éxito
                    Toast.success(response.message);
                }
                else{
                  Toast.error(response.message || 'Error al eliminar');
                }
            },
            error: function (xhr) {
                var response = xhr.responseJSON;
                if (response && response.message) {
                  Toast.error(response.message);
                } else {
                  Toast.error('Error al eliminar la marca');
                }
            },
            complete: function () {
                // Rehabilitar botón
               btn.prop('disabled', false).html(btnOriginal);
            }
        });
        }

    //

</script>
}