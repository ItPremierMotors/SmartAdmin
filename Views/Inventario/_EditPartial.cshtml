@model SmartAdmin.Models.Vehiculo.EditVehiculoViewModel
@using SmartAdmin.Models.Enums

<form id="formEditarVehiculo">
    <input type="hidden" asp-for="VehiculoId" />

    <!-- Sección 1: Identificación -->
    <h6 class="text-primary border-bottom pb-2 mb-3"><i class="fas fa-fingerprint me-2"></i>Identificación</h6>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label asp-for="Vin" class="form-label">@Html.DisplayNameFor(m => m.Vin)<span class="text-danger">*</span></label>
            <input asp-for="Vin" class="form-control text-uppercase" maxlength="17" required />
        </div>
        <div class="col-md-6 mb-3">
            <label asp-for="Placa" class="form-label">@Html.DisplayNameFor(m => m.Placa)</label>
            <input asp-for="Placa" class="form-control text-uppercase" />
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label asp-for="NumeroMotor" class="form-label">@Html.DisplayNameFor(m => m.NumeroMotor)</label>
            <input asp-for="NumeroMotor" class="form-control" />
        </div>
        <div class="col-md-6 mb-3">
            <label asp-for="NumeroChasis" class="form-label">@Html.DisplayNameFor(m => m.NumeroChasis)</label>
            <input asp-for="NumeroChasis" class="form-control" />
        </div>
    </div>

    <!-- Sección 2: Catálogo -->
    <h6 class="text-primary border-bottom pb-2 mb-3 mt-2"><i class="fas fa-car me-2"></i>Catálogo</h6>
    <div class="row">
        <div class="col-md-4 mb-3">
            <label asp-for="MarcaId" class="form-label">@Html.DisplayNameFor(m => m.MarcaId)<span class="text-danger">*</span></label>
            <select asp-for="MarcaId" class="form-select" id="MarcaId" required>
                <option value="">Seleccione marca...</option>
            </select>
        </div>
        <div class="col-md-4 mb-3">
            <label asp-for="ModeloId" class="form-label">@Html.DisplayNameFor(m => m.ModeloId)<span class="text-danger">*</span></label>
            <select asp-for="ModeloId" class="form-select" id="ModeloId" required>
                <option value="">Seleccione modelo...</option>
            </select>
        </div>
        <div class="col-md-4 mb-3">
            <label asp-for="VersionId" class="form-label">@Html.DisplayNameFor(m => m.VersionId)<span class="text-danger">*</span></label>
            <select asp-for="VersionId" class="form-select" id="VersionId" required>
                <option value="">Seleccione versión...</option>
            </select>
        </div>
    </div>
    <div class="row">
        <div class="col-md-3 mb-3">
            <label asp-for="Anio" class="form-label">@Html.DisplayNameFor(m => m.Anio)<span class="text-danger">*</span></label>
            <input asp-for="Anio" class="form-control" type="number" min="1900" max="2100" required />
        </div>
        <div class="col-md-3 mb-3">
            <label asp-for="Color" class="form-label">@Html.DisplayNameFor(m => m.Color)<span class="text-danger">*</span></label>
            <input asp-for="Color" class="form-control" required />
        </div>
    </div>

    <!-- Sección 3: Estado y Ubicación -->
    <h6 class="text-primary border-bottom pb-2 mb-3 mt-2"><i class="fas fa-map-marker-alt me-2"></i>Estado y Ubicación</h6>
    <div class="row">
        <div class="col-md-4 mb-3">
            <label asp-for="Estado" class="form-label">@Html.DisplayNameFor(m => m.Estado)</label>
            <select asp-for="Estado" class="form-select" id="Estado" disabled
                    asp-items="Html.GetEnumSelectList<EstadoVehiculo>()"></select>
            <small class="text-muted">Use "Cambiar Estado" desde el detalle</small>
        </div>
        <div class="col-md-4 mb-3">
            <label asp-for="UbicacionId" class="form-label">@Html.DisplayNameFor(m => m.UbicacionId)</label>
            <select asp-for="UbicacionId" class="form-select" id="UbicacionId">
                <option value="">Seleccione ubicación...</option>
            </select>
        </div>
        <div class="col-md-4 mb-3">
            <label asp-for="Procedencia" class="form-label">@Html.DisplayNameFor(m => m.Procedencia)</label>
            <select asp-for="Procedencia" class="form-select" id="Procedencia"
                    asp-items="Html.GetEnumSelectList<ProcedenciaVehiculo>()"></select>
        </div>
    </div>

    <!-- Sección 4: Importación -->
    <div id="seccionImportacion">
        <h6 class="text-primary border-bottom pb-2 mb-3 mt-2"><i class="fas fa-ship me-2"></i>Importación</h6>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label asp-for="NumeroImportacion" class="form-label">@Html.DisplayNameFor(m => m.NumeroImportacion)</label>
                <input asp-for="NumeroImportacion" class="form-control" />
            </div>
            <div class="col-md-4 mb-3">
                <label asp-for="NumeroPoliza" class="form-label">@Html.DisplayNameFor(m => m.NumeroPoliza)</label>
                <input asp-for="NumeroPoliza" class="form-control" />
            </div>
            <div class="col-md-4 mb-3">
                <label asp-for="CostoImportacion" class="form-label">@Html.DisplayNameFor(m => m.CostoImportacion)</label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input asp-for="CostoImportacion" class="form-control" type="number" step="0.01" min="0" />
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label asp-for="FechaIngresoPais" class="form-label">@Html.DisplayNameFor(m => m.FechaIngresoPais)</label>
                <input asp-for="FechaIngresoPais" class="form-control" type="date" />
            </div>
            <div class="col-md-6 mb-3">
                <label asp-for="FechaRecepcion" class="form-label">@Html.DisplayNameFor(m => m.FechaRecepcion)</label>
                <input asp-for="FechaRecepcion" class="form-control" type="date" />
            </div>
        </div>
    </div>

    <!-- Sección 5: Comercial -->
    <h6 class="text-primary border-bottom pb-2 mb-3 mt-2"><i class="fas fa-dollar-sign me-2"></i>Comercial</h6>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label asp-for="PrecioLista" class="form-label">@Html.DisplayNameFor(m => m.PrecioLista)</label>
            <div class="input-group">
                <span class="input-group-text">$</span>
                <input asp-for="PrecioLista" class="form-control" type="number" step="0.01" min="0" />
            </div>
        </div>
        <div class="col-md-6 mb-3 @(Model.Estado != 5 ? "d-none" : "")" id="seccionCliente">
            <label asp-for="ClienteId" class="form-label">@Html.DisplayNameFor(m => m.ClienteId)</label>
            <select asp-for="ClienteId" class="form-select" id="ClienteId">
                <option value="">Sin asignar</option>
            </select>
        </div>
    </div>

    <!-- Sección 6: Taller -->
    <h6 class="text-primary border-bottom pb-2 mb-3 mt-2"><i class="fas fa-wrench me-2"></i>Taller</h6>
    <div class="row">
        <div class="col-md-4 mb-3">
            <label asp-for="KilometrajeActual" class="form-label">@Html.DisplayNameFor(m => m.KilometrajeActual)</label>
            <input asp-for="KilometrajeActual" class="form-control" type="number" min="0" />
        </div>
        <div class="col-md-4 mb-3">
            <label asp-for="FechaPrimeraMatricula" class="form-label">@Html.DisplayNameFor(m => m.FechaPrimeraMatricula)</label>
            <input asp-for="FechaPrimeraMatricula" class="form-control" type="date" />
        </div>
        <div class="col-md-4 mb-3">
            <label asp-for="GarantiaHasta" class="form-label">@Html.DisplayNameFor(m => m.GarantiaHasta)</label>
            <input asp-for="GarantiaHasta" class="form-control" type="date" />
        </div>
    </div>

    <!-- Observaciones -->
    <div class="row">
        <div class="col-12 mb-3">
            <label asp-for="Observaciones" class="form-label">@Html.DisplayNameFor(m => m.Observaciones)</label>
            <textarea asp-for="Observaciones" class="form-control" rows="2"></textarea>
        </div>
    </div>
</form>

<div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="fas fa-times me-1"></i> Cancelar
    </button>
    <button type="button" class="btn btn-primary" id="btnActualizarVehiculo" onclick="actualizarVehiculo()">
        <i class="fas fa-save me-1"></i> Actualizar
    </button>
</div>

<script>
    (function () {
        var _preselect = {
            marcaId: '@Model.MarcaId',
            modeloId: '@Model.ModeloId',
            versionId: '@(Model.VersionId.HasValue ? Model.VersionId.Value.ToString() : "")'
        };
        var _cargaInicial = true;

        // Eventos de cascada
        $('#MarcaId').off('change').on('change', function () {
            if (_cargaInicial) return;
            $('#ModeloId').empty().append('<option value="">Seleccione modelo...</option>');
            $('#VersionId').empty().append('<option value="">Seleccione versión...</option>');
            var marcaId = $(this).val();
            if (marcaId) _cargarModelos(marcaId);
        });

        $('#ModeloId').off('change').on('change', function () {
            if (_cargaInicial) return;
            $('#VersionId').empty().append('<option value="">Seleccione versión...</option>');
            var modeloId = $(this).val();
            if (modeloId) _cargarVersiones(modeloId);
        });

        $('#VersionId').off('change').on('change', function () {
            if (_cargaInicial) return;
            var selected = $(this).find('option:selected');
            var precio = selected.data('precio');
            if (precio) $('#PrecioLista').val(precio);
        });

        // Carga secuencial con preselección
        _cargarMarcas(_preselect.marcaId, function () {
            if (!_preselect.marcaId || _preselect.marcaId === '0') { _cargaInicial = false; return; }
            _cargarModelos(_preselect.marcaId, _preselect.modeloId, function () {
                if (!_preselect.modeloId || _preselect.modeloId === '0') { _cargaInicial = false; return; }
                _cargarVersiones(_preselect.modeloId, _preselect.versionId, function () {
                    _cargaInicial = false;
                });
            });
        });

        _cargarUbicaciones();
        _initClienteSelect2();

        $('#Procedencia').off('change').on('change', function () {
            $('#seccionImportacion').toggle($(this).val() === '2');
        });
        $('#Procedencia').trigger('change');

        function _cargarMarcas(preselectId, callback) {
            $.get('@Url.Action("GetAll", "Marca")', function (res) {
                if (res.success && res.data) {
                    var select = $('#MarcaId');
                    res.data.forEach(function (m) {
                        var sel = preselectId && String(m.marcaId) === String(preselectId) ? ' selected' : '';
                        select.append('<option value="' + m.marcaId + '"' + sel + '>' + m.nombre + '</option>');
                    });
                }
                if (callback) callback();
            }).fail(function () {
                console.error('Error cargando marcas');
                if (callback) callback();
            });
        }

        function _cargarModelos(marcaId, preselectId, callback) {
            if (typeof preselectId === 'function') { callback = preselectId; preselectId = null; }
            $.get('@Url.Action("GetByMarca", "Modelos")?marcaId=' + marcaId, function (res) {
                if (res.success && res.data) {
                    var select = $('#ModeloId');
                    res.data.forEach(function (m) {
                        var sel = preselectId && String(m.modeloId) === String(preselectId) ? ' selected' : '';
                        select.append('<option value="' + m.modeloId + '"' + sel + '>' + m.nombre + '</option>');
                    });
                }
                if (callback) callback();
            }).fail(function () {
                console.error('Error cargando modelos para marca ' + marcaId);
                if (callback) callback();
            });
        }

        function _cargarVersiones(modeloId, preselectId, callback) {
            if (typeof preselectId === 'function') { callback = preselectId; preselectId = null; }
            $.get('@Url.Action("GetByModelo", "VersionesVehiculo")?modeloId=' + modeloId, function (res) {
                if (res.success && res.data) {
                    var select = $('#VersionId');
                    res.data.forEach(function (v) {
                        var sel = preselectId && String(v.versionId) === String(preselectId) ? ' selected' : '';
                        var precioAttr = v.precioBase ? ' data-precio="' + v.precioBase + '"' : '';
                        select.append('<option value="' + v.versionId + '"' + sel + precioAttr + '>' + v.nombre + '</option>');
                    });
                }
                if (callback) callback();
            }).fail(function () {
                console.error('Error cargando versiones para modelo ' + modeloId);
                if (callback) callback();
            });
        }

        function _cargarUbicaciones() {
            $.get('@Url.Action("GetUbicaciones", "Inventario")', function (res) {
                if (res.success && res.data) {
                    var select = $('#UbicacionId');
                    var currentValue = @(Model.UbicacionId.HasValue ? Model.UbicacionId.Value.ToString() : "null");
                    res.data.forEach(function (u) {
                        var selected = u.id == currentValue ? 'selected' : '';
                        select.append('<option value="' + u.id + '" ' + selected + '>' + u.nombre + (u.sucursalNombre ? ' (' + u.sucursalNombre + ')' : '') + '</option>');
                    });
                }
            });
        }

        function _initClienteSelect2() {
            $('#ClienteId').select2({
                dropdownParent: $('.modal'),
                theme: 'bootstrap-5',
                placeholder: 'Buscar cliente...',
                allowClear: true,
                minimumInputLength: 2,
                language: { inputTooShort: function () { return 'Escriba al menos 2 caracteres...'; } },
                ajax: {
                    url: '@Url.Action("Search", "Clientes")',
                    dataType: 'json',
                    delay: 300,
                    data: function (params) { return { term: params.term }; },
                    processResults: function (data) {
                        if (data.success && data.data) {
                            return {
                                results: data.data.map(function (c) {
                                    return { id: c.clienteId, text: c.nombreCompleto + ' (' + (c.dni || c.rtn || c.telefono) + ')' };
                                })
                            };
                        }
                        return { results: [] };
                    }
                }
            });

            @if (Model.ClienteId.HasValue)
            {
                @:var option = new Option(@Html.Raw(Json.Serialize((string)ViewBag.ClienteNombre)), '@Model.ClienteId', true, true);
                @:$('#ClienteId').append(option).trigger('change');
            }
        }
    })();
</script>
