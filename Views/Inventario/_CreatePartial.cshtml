@model SmartAdmin.Models.Vehiculo.CreateVehiculoViewModel
@using SmartAdmin.Models.Enums

@{
    if (Model.Estado == 0) { Model.Estado = (int)EstadoVehiculo.EnTransito; }
    if (Model.Procedencia == 0) { Model.Procedencia = (int)ProcedenciaVehiculo.Importado; }

    var estadoItems = Html.GetEnumSelectList<EstadoVehiculo>()
        .Where(x => int.TryParse(x.Value, out var v) && v <= 4).ToList();
}

<form id="formCrearVehiculo">
    <!-- Sección 1: Identificación -->
    <h6 class="text-primary border-bottom pb-2 mb-3"><i class="fas fa-fingerprint me-2"></i>Identificación</h6>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label asp-for="Vin" class="form-label">
                @Html.DisplayNameFor(m => m.Vin)<span class="text-danger">*</span>
            </label>
            <input asp-for="Vin" class="form-control text-uppercase" maxlength="17" placeholder="17 caracteres" required />
        </div>
        <div class="col-md-6 mb-3">
            <label asp-for="Placa" class="form-label">@Html.DisplayNameFor(m => m.Placa)</label>
            <input asp-for="Placa" class="form-control text-uppercase" placeholder="Ej: AAA-0000" />
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label asp-for="NumeroMotor" class="form-label">@Html.DisplayNameFor(m => m.NumeroMotor)</label>
            <input asp-for="NumeroMotor" class="form-control" />
        </div>
        <div class="col-md-6 mb-3">
            <label asp-for="NumeroChasis" class="form-label">@Html.DisplayNameFor(m => m.NumeroChasis)</label>
            <input asp-for="NumeroChasis" class="form-control" />
        </div>
    </div>

    <!-- Sección 2: Catálogo -->
    <h6 class="text-primary border-bottom pb-2 mb-3 mt-2"><i class="fas fa-car me-2"></i>Catálogo</h6>
    <div class="row">
        <div class="col-md-4 mb-3">
            <label asp-for="MarcaId" class="form-label">@Html.DisplayNameFor(m => m.MarcaId)<span class="text-danger">*</span></label>
            <select asp-for="MarcaId" class="form-select" id="MarcaId" required>
                <option value="">Seleccione marca...</option>
            </select>
        </div>
        <div class="col-md-4 mb-3">
            <label asp-for="ModeloId" class="form-label">@Html.DisplayNameFor(m => m.ModeloId)<span class="text-danger">*</span></label>
            <select asp-for="ModeloId" class="form-select" id="ModeloId" required>
                <option value="">Seleccione modelo...</option>
            </select>
        </div>
        <div class="col-md-4 mb-3">
            <label asp-for="VersionId" class="form-label">@Html.DisplayNameFor(m => m.VersionId)<span class="text-danger">*</span></label>
            <select asp-for="VersionId" class="form-select" id="VersionId" required>
                <option value="">Seleccione versión...</option>
            </select>
        </div>
    </div>
    <div class="row">
        <div class="col-md-3 mb-3">
            <label asp-for="Anio" class="form-label">@Html.DisplayNameFor(m => m.Anio)<span class="text-danger">*</span></label>
            <input asp-for="Anio" class="form-control" type="number" min="1900" max="2100" placeholder="2025" required />
        </div>
        <div class="col-md-3 mb-3">
            <label asp-for="Color" class="form-label">@Html.DisplayNameFor(m => m.Color)<span class="text-danger">*</span></label>
            <input asp-for="Color" class="form-control" placeholder="Ej: Blanco" required />
        </div>
    </div>

    <!-- Sección 3: Estado y Ubicación -->
    <h6 class="text-primary border-bottom pb-2 mb-3 mt-2"><i class="fas fa-map-marker-alt me-2"></i>Estado y Ubicación</h6>
    <div class="row">
        <div class="col-md-4 mb-3">
            <label asp-for="Estado" class="form-label">@Html.DisplayNameFor(m => m.Estado)</label>
            <select asp-for="Estado" class="form-select" id="Estado"
                    asp-items="@estadoItems"></select>
        </div>
        <div class="col-md-4 mb-3">
            <label asp-for="SucursalId" class="form-label">@Html.DisplayNameFor(m => m.SucursalId)</label>
            <select asp-for="SucursalId" class="form-select" id="SucursalId">
                <option value="">Seleccione sucursal...</option>
            </select>
        </div>
        <div class="col-md-4 mb-3">
            <label asp-for="Procedencia" class="form-label">@Html.DisplayNameFor(m => m.Procedencia)</label>
            <select asp-for="Procedencia" class="form-select" id="Procedencia"
                    asp-items="Html.GetEnumSelectList<ProcedenciaVehiculo>()"></select>
        </div>
    </div>

    <!-- Sección 4: Importación (condicional) -->
    <div id="seccionImportacion">
        <h6 class="text-primary border-bottom pb-2 mb-3 mt-2"><i class="fas fa-ship me-2"></i>Importación</h6>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label asp-for="NumeroImportacion" class="form-label">@Html.DisplayNameFor(m => m.NumeroImportacion)</label>
                <input asp-for="NumeroImportacion" class="form-control" />
            </div>
            <div class="col-md-4 mb-3">
                <label asp-for="NumeroPoliza" class="form-label">@Html.DisplayNameFor(m => m.NumeroPoliza)</label>
                <input asp-for="NumeroPoliza" class="form-control" />
            </div>
            <div class="col-md-4 mb-3">
                <label asp-for="CostoImportacion" class="form-label">@Html.DisplayNameFor(m => m.CostoImportacion)</label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input asp-for="CostoImportacion" class="form-control" type="number" step="0.01" min="0" />
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label asp-for="FechaIngresoPais" class="form-label">@Html.DisplayNameFor(m => m.FechaIngresoPais)</label>
                <input asp-for="FechaIngresoPais" class="form-control" type="date" />
            </div>
            <div class="col-md-6 mb-3">
                <label asp-for="FechaRecepcion" class="form-label">@Html.DisplayNameFor(m => m.FechaRecepcion)</label>
                <input asp-for="FechaRecepcion" class="form-control" type="date" />
            </div>
        </div>
    </div>

    <!-- Sección 5: Comercial -->
    <h6 class="text-primary border-bottom pb-2 mb-3 mt-2"><i class="fas fa-dollar-sign me-2"></i>Comercial</h6>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label asp-for="PrecioLista" class="form-label">@Html.DisplayNameFor(m => m.PrecioLista)</label>
            <div class="input-group">
                <span class="input-group-text">$</span>
                <input asp-for="PrecioLista" class="form-control" type="number" step="0.01" min="0" />
            </div>
        </div>
    </div>

    <!-- Sección 6: Taller -->
    <h6 class="text-primary border-bottom pb-2 mb-3 mt-2"><i class="fas fa-wrench me-2"></i>Taller</h6>
    <div class="row">
        <div class="col-md-4 mb-3">
            <label asp-for="KilometrajeActual" class="form-label">@Html.DisplayNameFor(m => m.KilometrajeActual)</label>
            <input asp-for="KilometrajeActual" class="form-control" type="number" min="0" value="0" />
        </div>
        <div class="col-md-4 mb-3">
            <label asp-for="FechaPrimeraMatricula" class="form-label">@Html.DisplayNameFor(m => m.FechaPrimeraMatricula)</label>
            <input asp-for="FechaPrimeraMatricula" class="form-control" type="date" />
        </div>
        <div class="col-md-4 mb-3">
            <label asp-for="GarantiaHasta" class="form-label">@Html.DisplayNameFor(m => m.GarantiaHasta)</label>
            <input asp-for="GarantiaHasta" class="form-control" type="date" />
        </div>
    </div>

    <!-- Sección 7: Observaciones -->
    <div class="row">
        <div class="col-12 mb-3">
            <label asp-for="Observaciones" class="form-label">@Html.DisplayNameFor(m => m.Observaciones)</label>
            <textarea asp-for="Observaciones" class="form-control" rows="2"></textarea>
        </div>
    </div>
</form>

<div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="fas fa-times me-1"></i> Cancelar
    </button>
    <button type="button" class="btn btn-primary" id="btnGuardarVehiculo" onclick="guardarVehiculo()">
        <i class="fas fa-save me-1"></i> Guardar
    </button>
</div>

<script>
    (function () {
        var s2Opts = { dropdownParent: $('.modal'), theme: 'bootstrap-5', width: '100%' };

        function _initSelect2(selector, opts) {
            var $el = $(selector);
            if ($el.hasClass('select2-hidden-accessible')) $el.select2('destroy');
            $el.select2($.extend({}, s2Opts, opts));
        }

        // Cascada Marca -> Modelo -> Versión
        $('#MarcaId').off('change').on('change', function () {
            var $modelo = $('#ModeloId'), $version = $('#VersionId');
            if ($modelo.hasClass('select2-hidden-accessible')) $modelo.select2('destroy');
            if ($version.hasClass('select2-hidden-accessible')) $version.select2('destroy');
            $modelo.empty().append('<option value="">Seleccione modelo...</option>');
            $version.empty().append('<option value="">Seleccione versión...</option>');
            var marcaId = $(this).val();
            if (marcaId) _cargarModelos(marcaId);
        });

        $('#ModeloId').off('change').on('change', function () {
            var $version = $('#VersionId');
            if ($version.hasClass('select2-hidden-accessible')) $version.select2('destroy');
            $version.empty().append('<option value="">Seleccione versión...</option>');
            var modeloId = $(this).val();
            if (modeloId) _cargarVersiones(modeloId);
        });

        $('#VersionId').off('change').on('change', function () {
            var selected = $(this).find('option:selected');
            var precio = selected.data('precio');
            if (precio) $('#PrecioLista').val(precio);
        });

        $('#Procedencia').off('change').on('change', function () {
            $('#seccionImportacion').toggle($(this).val() === '2');
        });
        $('#Procedencia').trigger('change');

        // Cargar datos e inicializar Select2 DESPUÉS de poblar opciones
        _cargarMarcas(function () {
            _initSelect2('#MarcaId', { placeholder: 'Seleccione marca...' });
        });
        _cargarSucursales();

        function _cargarMarcas(callback) {
            $.get('@Url.Action("GetAll", "Marca")', function (res) {
                if (res.success && res.data) {
                    var select = $('#MarcaId');
                    res.data.forEach(function (m) { select.append('<option value="' + m.marcaId + '">' + m.nombre + '</option>'); });
                }
                if (callback) callback();
            });
        }

        function _cargarModelos(marcaId) {
            $.get('@Url.Action("GetByMarca", "Modelos")?marcaId=' + marcaId, function (res) {
                if (res.success && res.data) {
                    var select = $('#ModeloId');
                    res.data.forEach(function (m) { select.append('<option value="' + m.modeloId + '">' + m.nombre + '</option>'); });
                }
                _initSelect2('#ModeloId', { placeholder: 'Seleccione modelo...' });
            });
        }

        function _cargarVersiones(modeloId) {
            $.get('@Url.Action("GetByModelo", "VersionesVehiculo")?modeloId=' + modeloId, function (res) {
                if (res.success && res.data) {
                    var select = $('#VersionId');
                    res.data.forEach(function (v) {
                        var precioAttr = v.precioBase ? ' data-precio="' + v.precioBase + '"' : '';
                        select.append('<option value="' + v.versionId + '"' + precioAttr + '>' + v.nombre + '</option>');
                    });
                }
                _initSelect2('#VersionId', { placeholder: 'Seleccione versión...' });
            });
        }

        function _cargarSucursales() {
            $.get('@Url.Action("GetSucursales", "Inventario")', function (res) {
                if (res.success && res.data) {
                    var select = $('#SucursalId');
                    res.data.forEach(function (s) { select.append('<option value="' + s.id + '">' + s.nombre + '</option>'); });
                }
            });
        }
    })();
</script>
