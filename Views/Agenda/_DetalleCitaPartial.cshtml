@model SmartAdmin.Models.Taller.CitaViewModel
@{
    var badgeClass = Model.Estado switch
    {
        SmartAdmin.Models.Enums.EstadoCita.Agendada => "bg-primary",
        SmartAdmin.Models.Enums.EstadoCita.Confirmada => "bg-info",
        SmartAdmin.Models.Enums.EstadoCita.EnProceso => "bg-warning text-dark",
        SmartAdmin.Models.Enums.EstadoCita.Completada => "bg-success",
        SmartAdmin.Models.Enums.EstadoCita.Cancelada => "bg-danger",
        SmartAdmin.Models.Enums.EstadoCita.NoShow => "bg-dark",
        _ => "bg-secondary"
    };

    var tipoIngresoNombre = Model.TipoIngreso switch
    {
        SmartAdmin.Models.Enums.TipoIngreso.Cita => "Cita",
        SmartAdmin.Models.Enums.TipoIngreso.WalkIn => "Walk-In",
        SmartAdmin.Models.Enums.TipoIngreso.Garantia => "Garantia",
        _ => "Otro"
    };
}

<!-- Header with status -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <span class="badge @badgeClass fs-6">@Model.EstadoNombre</span>
        <span class="badge bg-secondary ms-1">@tipoIngresoNombre</span>
    </div>
    <code class="fs-6">@Model.CodigoCita</code>
</div>

<div class="row">
    <!-- Left: Info -->
    <div class="col-md-6">
        <!-- Cliente -->
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-user me-2"></i>Cliente</h6>
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless mb-0">
                    <tr>
                        <td class="text-muted" style="width:35%">Nombre:</td>
                        <td class="fw-bold">@Model.ClienteNombre</td>
                    </tr>
                    @if (!string.IsNullOrEmpty(Model.ClienteTelefono))
                    {
                        <tr>
                            <td class="text-muted">Telefono:</td>
                            <td>@Model.ClienteTelefono</td>
                        </tr>
                    }
                </table>
            </div>
        </div>

        <!-- Vehiculo -->
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-car me-2"></i>Vehiculo</h6>
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless mb-0">
                    <tr>
                        <td class="text-muted" style="width:35%">Vehiculo:</td>
                        <td class="fw-bold">@Model.VehiculoDescripcion</td>
                    </tr>
                    @if (!string.IsNullOrEmpty(Model.VehiculoPlaca))
                    {
                        <tr>
                            <td class="text-muted">Placa:</td>
                            <td>@Model.VehiculoPlaca</td>
                        </tr>
                    }
                </table>
            </div>
        </div>
    </div>

    <!-- Right: Schedule & Service -->
    <div class="col-md-6">
        <!-- Horario -->
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-clock me-2"></i>Horario</h6>
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless mb-0">
                    <tr>
                        <td class="text-muted" style="width:35%">Fecha:</td>
                        <td class="fw-bold">@Model.FechaFormateada</td>
                    </tr>
                    @if (Model.FechaRecepcion.Date != Model.FechaHoraInicio.Date)
                    {
                        <tr>
                            <td class="text-muted">Recepcion:</td>
                            <td><span class="badge bg-info">@Model.FechaRecepcionFormateada</span></td>
                        </tr>
                    }
                    <tr>
                        <td class="text-muted">Hora Inicio:</td>
                        <td>@Model.HoraInicioFormateada</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Hora Fin:</td>
                        <td>@Model.HoraFinFormateada</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Duracion:</td>
                        <td>@Model.DuracionMinutos min</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Servicio -->
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-wrench me-2"></i>Servicio</h6>
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless mb-0">
                    <tr>
                        <td class="text-muted" style="width:35%">Tipo:</td>
                        <td class="fw-bold">@Model.TipoServicioNombre</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Motivo:</td>
                        <td>@Model.MotivoVisita</td>
                    </tr>
                    @if (!string.IsNullOrEmpty(Model.Observaciones))
                    {
                        <tr>
                            <td class="text-muted">Observaciones:</td>
                            <td>@Model.Observaciones</td>
                        </tr>
                    }
                </table>
            </div>
        </div>
    </div>
</div>

@if (Model.MinutosTrabajados.HasValue && Model.MinutosTrabajados > 0)
{
    <div class="alert alert-info mb-3">
        <i class="fas fa-clock me-1"></i>
        <strong>Minutos trabajados acumulados:</strong> @Model.MinutosTrabajados min
        â€” @Model.DuracionMinutos min pendientes.
    </div>
}

@if (Model.Estado == SmartAdmin.Models.Enums.EstadoCita.Cancelada && !string.IsNullOrEmpty(Model.MotivoCancelacion))
{
    <div class="alert alert-danger mb-3">
        <i class="fas fa-ban me-1"></i>
        <strong>Motivo de cancelacion:</strong> @Model.MotivoCancelacion
    </div>
}

<!-- Action Buttons -->
@{
    var esFechaPasada = Model.FechaHoraInicio.Date < DateTime.Today;
}
<div class="d-flex justify-content-between mt-3 pt-3 border-top">
    <div>
        @if (esFechaPasada && (Model.Estado == SmartAdmin.Models.Enums.EstadoCita.Agendada
            || Model.Estado == SmartAdmin.Models.Enums.EstadoCita.Confirmada
            || Model.Estado == SmartAdmin.Models.Enums.EstadoCita.EnProceso))
        {
            <span class="badge bg-secondary me-2 align-middle"><i class="fas fa-exclamation-triangle me-1"></i>Fecha vencida</span>
            @if (Model.Estado == SmartAdmin.Models.Enums.EstadoCita.EnProceso)
            {
                <button class="btn btn-sm btn-primary me-1" onclick="abrirTransferirCita(@Model.CitaId)">
                    <i class="fas fa-exchange-alt me-1"></i> Transferir a manana
                </button>
            }
            else
            {
                <button class="btn btn-sm btn-primary me-1" onclick="abrirReprogramarCita(@Model.CitaId)">
                    <i class="fas fa-calendar-day me-1"></i> Reprogramar
                </button>
                <button class="btn btn-sm btn-danger" onclick="cancelarCita(@Model.CitaId)">
                    <i class="fas fa-times me-1"></i> Cancelar
                </button>
            }
        }
        else
        {
            @switch (Model.Estado)
            {
                case SmartAdmin.Models.Enums.EstadoCita.Agendada:
                    <button class="btn btn-sm btn-info me-1" onclick="accionCita('confirmar', @Model.CitaId)">
                        <i class="fas fa-check me-1"></i> Confirmar
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="cancelarCita(@Model.CitaId)">
                        <i class="fas fa-times me-1"></i> Cancelar
                    </button>
                    break;
                case SmartAdmin.Models.Enums.EstadoCita.Confirmada:
                    <button class="btn btn-sm btn-warning me-1" onclick="accionCita('iniciar', @Model.CitaId)">
                        <i class="fas fa-play me-1"></i> Iniciar Atencion
                    </button>
                    <button class="btn btn-sm btn-dark me-1" onclick="accionCita('noshow', @Model.CitaId)">
                        <i class="fas fa-user-slash me-1"></i> No Show
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="cancelarCita(@Model.CitaId)">
                        <i class="fas fa-times me-1"></i> Cancelar
                    </button>
                    break;
                case SmartAdmin.Models.Enums.EstadoCita.EnProceso:
                    <button class="btn btn-sm btn-success me-1" onclick="accionCita('completar', @Model.CitaId)">
                        <i class="fas fa-check-double me-1"></i> Completar
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="abrirTransferirCita(@Model.CitaId)">
                        <i class="fas fa-exchange-alt me-1"></i> Transferir a manana
                    </button>
                    break;
            }
        }
    </div>
    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
</div>
