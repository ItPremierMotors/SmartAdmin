@model SmartAdmin.Models.Taller.CapacidadTallerViewModel
@{
    var fecha = (DateTime)ViewBag.Fecha;
    var bloques = ViewBag.Bloques as List<SmartAdmin.Models.Taller.BloqueHorarioViewModel> ?? new List<SmartAdmin.Models.Taller.BloqueHorarioViewModel>();
    var esFechaPasada = fecha.Date < DateTime.Now.Date;
}

@if (Model == null)
{
    <div class="text-center py-4">
        <i class="fas fa-calendar-plus fa-3x text-muted mb-3"></i>
        <p class="text-muted">No hay capacidad configurada para este dia.</p>
        @if (esFechaPasada)
        {
            <div class="alert alert-secondary mt-3">
                <i class="fas fa-lock me-1"></i> No se puede crear capacidad para fechas pasadas.
            </div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        }
        else
        {
            <hr />
            <form id="formCrearCapacidad">
                <input type="hidden" id="NuevaCapFecha" value="@fecha.ToString("yyyy-MM-dd")" />
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Turno <span class="text-danger">*</span></label>
                        <select class="form-select" id="NuevaCapTurno" required>
                            <option value="1">Manana</option>
                            <option value="2">Tarde</option>
                            <option value="3" selected>Completo</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tecnicos <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="NuevaCapTecnicos" min="1" max="50" value="4" required />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Bahias <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="NuevaCapBahias" min="1" max="50" value="4" required />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Min. por Tecnico <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="NuevaCapMinutosPorTecnico" min="60" max="1440" value="480" required />
                    </div>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="NuevaCapSobretiempo" checked />
                    <label class="form-check-label" for="NuevaCapSobretiempo">Permitir sobretiempo</label>
                </div>
            </form>
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="btnCrearCapacidad" onclick="confirmarCrearCapacidad()">
                    <i class="fas fa-plus me-1"></i> Crear Capacidad
                </button>
            </div>
        }
    </div>
}
else
{
    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="card border-0 bg-primary bg-opacity-10 text-center">
                <div class="card-body py-2">
                    <div class="fs-4 fw-bold text-primary">@Model.PorcentajeOcupacion.ToString("F0")%</div>
                    <small class="text-muted">Ocupacion</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-0 bg-success bg-opacity-10 text-center">
                <div class="card-body py-2">
                    <div class="fs-4 fw-bold text-success">@(Model.MinutosDisponibles / 60)h</div>
                    <small class="text-muted">Disponible</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-0 bg-info bg-opacity-10 text-center">
                <div class="card-body py-2">
                    <div class="fs-4 fw-bold text-info">@Model.TecnicosDisponibles</div>
                    <small class="text-muted">Tecnicos</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-0 bg-warning bg-opacity-10 text-center">
                <div class="card-body py-2">
                    <div class="fs-4 fw-bold text-warning">@Model.BahiasDisponibles</div>
                    <small class="text-muted">Bahias</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Capacity Info Table -->
    <div class="card mb-3">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-cog me-2"></i>Configuracion</h6>
            <div>
                @if (Model.PermiteAgendamiento)
                {
                    <span class="badge bg-success">Agendamiento activo</span>
                }
                else
                {
                    <span class="badge bg-danger">Bloqueado</span>
                }
                @if (Model.PermiteSobretiempo)
                {
                    <span class="badge bg-info ms-1">Sobretiempo</span>
                }
            </div>
        </div>
        <div class="card-body p-0">
            <table class="table table-sm table-borderless mb-0">
                <tbody>
                    <tr>
                        <td class="text-muted ps-3" style="width:40%">Turno:</td>
                        <td class="fw-bold">@Model.TurnoNombre</td>
                    </tr>
                    <tr>
                        <td class="text-muted ps-3">Minutos Reservados:</td>
                        <td>@Model.MinutosReservados / @Model.MinutosDisponibles</td>
                    </tr>
                    <tr>
                        <td class="text-muted ps-3">Minutos Utilizados:</td>
                        <td>@Model.MinutosUtilizados</td>
                    </tr>
                    @if (Model.TuvoSobretiempo)
                    {
                        <tr>
                            <td class="text-muted ps-3">Sobretiempo:</td>
                            <td class="text-danger fw-bold">@Model.MinutosSobretiempo min</td>
                        </tr>
                    }
                    @if (!string.IsNullOrEmpty(Model.Observaciones))
                    {
                        <tr>
                            <td class="text-muted ps-3">Observaciones:</td>
                            <td>@Model.Observaciones</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bloques Horarios -->
    <div class="card mb-3">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-th me-2"></i>Bloques Horarios (@bloques.Count)</h6>
            @if (!esFechaPasada)
            {
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-success" onclick="abrirCrearBloque(@Model.CapacidadId)">
                        <i class="fas fa-plus me-1"></i> Nuevo
                    </button>
                    <button class="btn btn-outline-primary" onclick="abrirGenerarBloques(@Model.CapacidadId)">
                        <i class="fas fa-magic me-1"></i> Generar
                    </button>
                </div>
            }
        </div>
        @if (bloques.Count > 0)
        {
            <div class="card-body p-0">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Horario</th>
                            <th class="text-center">Tipo</th>
                            <th class="text-center">Cap.</th>
                            <th class="text-center">Agend.</th>
                            <th class="text-center">Estado</th>
                            <th class="text-center" style="width:90px">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var b in bloques.OrderBy(x => x.HoraInicio))
                        {
                            var pctBloque = b.CapacidadMaximaVehiculos > 0
                                ? (b.VehiculosAgendados * 100 / b.CapacidadMaximaVehiculos) : 0;
                            var badgeClass = pctBloque >= 100 ? "bg-danger" :
                                             pctBloque >= 70 ? "bg-warning text-dark" : "bg-success";
                            <tr>
                                <td><i class="fas fa-clock me-1 text-muted"></i>@b.HoraInicioFormateada - @b.HoraFinFormateada</td>
                                <td class="text-center"><span class="badge bg-secondary">@b.TipoBloqueNombre</span></td>
                                <td class="text-center">@b.CapacidadMaximaVehiculos</td>
                                <td class="text-center">@b.VehiculosAgendados</td>
                                <td class="text-center">
                                    <span class="badge @badgeClass">
                                        @(b.TieneEspacioDisponible ? $"{b.EspaciosDisponibles} libres" : "Lleno")
                                    </span>
                                </td>
                                <td class="text-center">
                                    @if (!esFechaPasada)
                                    {
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary btn-sm" title="Editar"
                                                    onclick="abrirEditarBloque(@b.BloqueId, '@b.HoraInicioFormateada', '@b.HoraFinFormateada', @b.CapacidadMaximaVehiculos, @((int)b.TipoBloque))">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" title="Eliminar"
                                                    onclick="eliminarBloque(@b.BloqueId, '@b.HoraInicioFormateada - @b.HoraFinFormateada')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="card-body text-center text-muted py-3">
                <i class="fas fa-inbox me-1"></i> Sin bloques horarios configurados
            </div>
        }
    </div>

    <!-- Action Buttons -->
    <div class="d-flex justify-content-between mt-3 pt-3 border-top">
        <div>
            @if (!esFechaPasada)
            {
                if (Model.PermiteAgendamiento)
                {
                    <button class="btn btn-sm btn-outline-danger" onclick="bloquearDia(@Model.CapacidadId)">
                        <i class="fas fa-ban me-1"></i> Bloquear Dia
                    </button>
                }
                else
                {
                    <button class="btn btn-sm btn-outline-success" onclick="desbloquearDia(@Model.CapacidadId)">
                        <i class="fas fa-check-circle me-1"></i> Desbloquear
                    </button>
                }
            }
            else
            {
                <span class="badge bg-secondary"><i class="fas fa-lock me-1"></i>Fecha pasada - solo lectura</span>
            }
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
            @if (!esFechaPasada)
            {
                <button type="button" class="btn btn-primary btn-sm" onclick="abrirEditarCapacidad(@Model.CapacidadId)">
                    <i class="fas fa-edit me-1"></i> Editar
                </button>
            }
        </div>
    </div>
}
