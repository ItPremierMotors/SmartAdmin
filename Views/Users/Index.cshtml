@{
    ViewData["Title"] = "Administración de Usuarios";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0"><i class="fas fa-users me-2"></i>@ViewData["Title"]</h1>
        <button class="btn btn-primary" id="btnNuevo">
            <i class="fas fa-plus me-2"></i>Nuevo Usuario
        </button>
    </div>

    <div class="card">
        <div class="card-body">
            <div id="loading" class="text-center py-4">
                <div class="spinner-border text-primary"></div>
            </div>

            <table class="table table-hover d-none" id="tabla" style="width:100%">
                <thead class="table-light">
                    <tr>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Cargo</th>
                        <th>Roles</th>
                        <th>Estado</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const URLS = {
            getAll: '@Url.Action("GetAll")',
            create: '@Url.Action("Create")',
            update: '@Url.Action("Update")',
            resetPassword: '@Url.Action("ResetPassword")',
            createPartial: '@Url.Action("CreatePartial")',
            editPartial: '@Url.Action("EditPartial")',
            detailPartial: '@Url.Action("DetailPartial")',
            resetPasswordPartial: '@Url.Action("ResetPasswordPartial")'
        };

        let dataTable = null;

        $(document).ready(function () {
            inicializarDataTable();
            $('#btnNuevo').on('click', abrirModalCrear);
        });

        function inicializarDataTable() {
            dataTable = $('#tabla').DataTable({
                ajax: {
                    url: URLS.getAll,
                    dataSrc: function (res) {
                        $('#loading').addClass('d-none');
                        $('#tabla').removeClass('d-none');
                        return res.success ? (res.data || []) : [];
                    }
                },
                columns: [
                    {
                        data: 'nombreCompleto',
                        render: data => data || 'N/A'
                    },
                    { data: 'email' },
                    {
                        data: 'cargo',
                        render: data => data || 'N/A'
                    },
                    {
                        data: 'roles',
                        render: function(data) {
                            if (!data || data.length === 0) return '<span class="text-muted">Sin roles</span>';
                            return data.map(r => `<span class="badge bg-${r === 'AdminTI' ? 'danger' : 'info'} me-1">${r}</span>`).join('');
                        }
                    },
                    {
                        data: 'activo',
                        render: data => data
                            ? '<span class="badge bg-success">Activo</span>'
                            : '<span class="badge bg-danger">Inactivo</span>'
                    },
                    {
                        data: 'id',
                        orderable: false,
                        className: 'text-center',
                        render: (data, type, row) => `
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="abrirModalDetalle('${data}')"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-outline-primary" onclick="abrirModalEditar('${data}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-outline-warning" onclick="abrirModalResetPassword('${data}', '${row.email}')"><i class="fas fa-key"></i></button>
                            </div>
                        `
                    }
                ],
                language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json' },
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50],
                order: [[0, 'asc']]
            });
        }

        function recargarTabla() {
            dataTable.ajax.reload(null, false);
        }
       

        // ============ MODALES ============
        function abrirModalCrear() {
            AppModal.open({
                title: '<i class="fas fa-user-plus me-2"></i>Nuevo Usuario',
                url: URLS.createPartial,
                size: 'lg'
            });
        }

        function abrirModalDetalle(id) {
            AppModal.open({
                title: '<i class="fas fa-user me-2"></i>Detalle del Usuario',
                url: URLS.detailPartial,
                data: { id: id },
                size: 'md'
            });
        }

        function abrirModalEditar(id) {
            AppModal.open({
                title: '<i class="fas fa-user-edit me-2"></i>Editar Usuario',
                url: URLS.editPartial,
                data: { id: id },
                size: 'lg'
            });
        }
        
        function abrirModalResetPassword(id, email) {
            AppModal.open({
                title: '<i class="fas fa-key me-2"></i>Cambiar Contraseña',
                url: URLS.resetPasswordPartial,
                data: { id: id, email: email },
                size: 'md'
            });
        }

        // ============ ACCIONES ============
        function actualizarUsuario() {
            const id = $('#txtId').val();
            const nombre = $('#txtNombre').val();

            let cargo = $('#txtCargoNuevo').val();
            if (!cargo) cargo = $('#txtCargo').val();

            const activo = $('#chkActivo').is(':checked');
            const roles = [];
            $('.role-checkbox:checked').each(function() {
                roles.push($(this).val());
            });

            if (!nombre) {
                Toast.warning('El nombre es obligatorio');
                return;
            }

            $.ajax({
                url: '@Url.Action("Update")' +'?id=' + id,
                type: 'Post',
                contentType: 'application/json',
                data: JSON.stringify({
                    nombreCompleto: nombre,
                    cargo: cargo,
                    activo: activo,
                    roles: roles
                }),
                success: function (res) {
                    if (res.success) {
                        Toast.success('Usuario actualizado correctamente');
                        AppModal.close();
                        recargarTabla();
                    } else {
                        Toast.error(res.message || 'Error al actualizar');
                    }
                },
                error: function () {
                    Toast.error('Error de comunicación con el servidor');
                }
            });
        }

        function guardarUsuario() {
            //inicio
            
            const nombre = $('#NombreCompleto').val();
            const email = $('#Email').val();
            let cargo = $('#txtCargoNuevo').val();
            let password=$('#Password').val();   
            let departamento = $('#txtDepartamentoNuevo').val();
            if (!cargo) cargo = $('#txtCargo').val();
            if (!departamento) departamento = $('#txtDepartamento').val();

            const activo = $('#chkActivo').is(':checked');
            const roles = [];
            $('.role-checkbox:checked').each(function() {
                roles.push($(this).val());
            });

            if (!nombre) {
                Toast.warning('El nombre es obligatorio');
                return;
            }
            if (!password) {
                Toast.warning('Contraseña obligatoria');
                return;
            }

            $.ajax({
                url: '@Url.Action("Create")',
                type: 'Post',
                contentType: 'application/json',
                data: JSON.stringify({
                    email:email,
                    password:password,
                    ConfirmPassword:password,
                    nombreCompleto: nombre,
                    cargo: cargo,
                    departamento:departamento,
                    activo: activo,
                    roles: roles
                }),
                success: function (res) {
                    if (res.success) {
                        Toast.success('Usuario Creado correctamente');
                        AppModal.close();
                        recargarTabla();
                    } else {
                        Toast.error(res.message || 'Error al crear');
                    }
                },
                error: function () {
                    Toast.error('Error de comunicación con el servidor');
                }
            });
            //fin
        }

        function cambiarPassword() {
            const id=$('#pwdUserId').val();
            const newPassword=$('#txtNewPassword').val();
            const confirmPassword = $('#txtConfirmPassword').val();
            //validaciones
            if(!newPassword){
               Toast.warning('La contraseña es obligatoria');
               return;
            }
            if (newPassword !== confirmPassword) {
               Toast.warning('Las contraseñas no coinciden');
               return;
             }

             //peticiona ajax para actualizar controller
             $.ajax({
                 //inicio ajax
                 url:'@Url.Action("ResetPassword")' +'?id=' + id,
                 type: 'POST',
                 contentType: 'application/json',
                 data: JSON.stringify({NewPassword:newPassword}),
                 success:function(res){
                     if(res.success){
                        Toast.success('Contraseña actualizada correctamente');
                        AppModal.close();
                     }else {
                        Toast.error(res.message || 'Error al cambiar contraseña');
                     }
                 },
                 error: function(){
                    Toast.error('Error de comunicación con el servidor');
                 }
                 //fin ajax
             });
        }
    </script>
}