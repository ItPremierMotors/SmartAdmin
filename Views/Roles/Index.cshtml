@{
    ViewData["Title"] = "Administración de Roles";
}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0"><i class="fas fa-users me-2"></i>@ViewData["Title"]</h1>
        <button class="btn btn-primary" id="btnNuevo">
            <i class="fas fa-plus me-2"></i>Nuevo Rol
        </button>
    </div>

    <div class="card">
        <div class="card-body">
            <div id="loading" class="text-center py-4">
                <div class="spinner-border text-primary"></div>
            </div>

            <table class="table table-hover d-none" id="tabla" style="width:100%">
                <thead class="table-light">
                    <tr>
                        <th>Nombre</th>
                        <th>Cantidad de usuarios</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts{
    <script>
        const URLS = {
            getAll: '@Url.Action("GetAll")',
            create: '@Url.Action("Create")',
            update: '@Url.Action("edit")',
            createPartial: '@Url.Action("CreatePartial")',
            editPartial: '@Url.Action("EditPartial")',
            detailPartial: '@Url.Action("DetailPartial")'
        };
        //definir datatable
        let dataTable = null;

         $(document).ready(function () {
            inicializarDataTable();
            $('#btnNuevo').on('click', abrirModalCrear);
        });

        function inicializarDataTable(){
            dataTable=$('#tabla').DataTable({
                ajax: {
                    url: URLS.getAll,
                    dataSrc: function (res) {
                        $('#loading').addClass('d-none');
                        $('#tabla').removeClass('d-none');
                        Toast.success(res.message)
                        return res.success ? (res.data || []) : [];
                    }
                },
                 columns: [
                    {
                        data: 'name',
                        render: data => data || 'N/A'
                    },
                    { data: 'usersCount' },
                    {
                        data: 'id',
                        orderable: false,
                        className: 'text-center',
                        render: (data, type, row) => `
                            <div class="btn-group btn-group-sm">
                                  <button class="btn btn-outline-primary" onclick="abrirModalEditar('${data}')"><i class="fas fa-edit"></i></button>
                            </div>
                        `
                    }
                ],
                language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json' },
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50],
                order: [[0, 'asc']]
            });
            
        }
        //funciones extra
        function recargarTabla() {
           dataTable.ajax.reload(null, false);
        }

        //Acciones 
        //crear
          function guardarRol(){
          const rol=$('#Name').val();
          if(!rol){
           Toast.warning("Este campo no puede ir vacio")
          }
          $.ajax({
            url: '@Url.Action("create")',
            type: 'Post',
            contentType: 'application/json',
            data: JSON.stringify({
               name: rol
            }),
            success: function(res){
            if(res.success){
                Toast.success('Rol Creado correctamente');
                AppModal.close();
                recargarTabla();
            } else {
                Toast.error(res.message || 'Error al crear');
            }
            },
            error: function () {
              Toast.error('Error de comunicación con el servidor');
            }
          });
        }
        //editar
       function ModificarRol(){
           const rol=$('#Name').val();
            const id=$('#Id').val();
           if(!rol){
            Toast.warning("Este campo no puede ir vacio")
           }
           $.ajax({
             url: URLS.update,
             type: 'Post',
             contentType: 'application/json',
             data: JSON.stringify({
                name: rol,
                id: id
             }),
             success: function(res){
             if(res.success){
                 Toast.success('Rol Creado correctamente');
                 AppModal.close();
                 recargarTabla();
             } else {
                 Toast.error(res.message || 'Error al crear');
             }
             },
             error: function () {
               Toast.error('Error de comunicación con el servidor');
             }
           });
       }
        //eliminar


        //modales
        function abrirModalCrear() {
            AppModal.open({
                title: '<i class="fas fa-user-plus me-2"></i>Nuevo Rol',
                url: URLS.createPartial,
                size: 'lg'
            });
        }
        function abrirModalEditar(id) {
        AppModal.open({
            title: '<i class="fas fa-user-edit me-2"></i>Editar Rol',
                url: URLS.editPartial,
                data: { 
                    id: id,
                },
            size: 'lg'
        });
    }
    </script>
}