@{
    ViewData["Title"] = "Flota - Vehículos Entregados";
}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0"><i class="fas fa-car-side me-2"></i>@ViewData["Title"]</h1>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <label class="form-label small text-muted">Cliente</label>
                    <select class="form-select form-select-sm" id="filtroCliente">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">Buscar</label>
                    <input type="text" class="form-control form-control-sm" id="filtroBuscar" placeholder="VIN, Placa, Descripción..." />
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-outline-secondary btn-sm" onclick="limpiarFiltros()">
                        <i class="fas fa-eraser me-1"></i> Limpiar
                    </button>
                </div>
            </div>

            <div id="loading" class="text-center py-4">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2 text-muted">Cargando flota...</p>
            </div>

            <table class="table table-hover table-sm d-none" id="tablaFlota" style="width:100%">
                <thead class="table-light">
                    <tr>
                        <th>Placa</th>
                        <th>Descripción</th>
                        <th>Cliente</th>
                        <th>Fecha Entrega</th>
                        <th>Kilometraje</th>
                        <th>Garantía</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const URLS = {
        getAll: '@Url.Action("GetAll", "Flota")',
        getDetail: '@Url.Action("DetailPartial", "Flota")',
        editPartial: '@Url.Action("EditPartial", "Flota")',
        edit: '@Url.Action("Edit", "Flota")',
        actualizarKm: '@Url.Action("ActualizarKilometraje", "Flota")'
    };

    const ESTADO_ENTREGADO = 7;

    let dtFlota = null;
    let datosOriginales = [];

    $(document).ready(function () {
        cargarDatos();

        $('#filtroCliente').select2({
            theme: 'bootstrap-5',
            allowClear: true,
            placeholder: 'Buscar cliente...',
            width: '100%',
            minimumInputLength: 2,
            language: { inputTooShort: () => 'Escriba al menos 2 caracteres...' },
            ajax: {
                url: '@Url.Action("Search", "Clientes")',
                dataType: 'json',
                delay: 300,
                data: function (params) { return { term: params.term }; },
                processResults: function (data) {
                    if (data.success && data.data) {
                        return {
                            results: data.data.map(c => ({
                                id: c.nombreCompleto,
                                text: c.nombreCompleto + ' (' + (c.dni || c.rtn || c.telefono) + ')'
                            }))
                        };
                    }
                    return { results: [] };
                }
            }
        });

        $('#filtroCliente').on('change', aplicarFiltros);
    });

    function cargarDatos() {
        $.ajax({
            url: URLS.getAll,
            type: 'GET',
            success: function (response) {
                if (response.success && response.data) {
                    datosOriginales = response.data.filter(v => v.estado === ESTADO_ENTREGADO);
                    renderizarTabla(datosOriginales);
                } else {
                    Toast.error('Error al cargar flota');
                }
                $('#loading').addClass('d-none');
            },
            error: function () {
                Toast.error('Error al conectar con el servidor');
                $('#loading').addClass('d-none');
            }
        });
    }

    function renderizarTabla(datos) {
        if (dtFlota) dtFlota.destroy();

        dtFlota = $('#tablaFlota').DataTable({
            data: datos,
            columns: [
                {
                    data: 'identificador',
                    render: data => `<strong>${data}</strong>`
                },
                {
                    data: 'descripcionCompleta',
                    render: data => data || 'N/A'
                },
                {
                    data: 'clienteNombre',
                    render: data => data || '<span class="text-muted">Sin asignar</span>'
                },
                {
                    data: 'fechaEntrega',
                    render: data => {
                        if (data) {
                            const d = new Date(data);
                            return d.toLocaleDateString('es-HN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        }
                        return '<span class="text-muted">N/A</span>';
                    }
                },
                {
                    data: 'kilometrajeActual',
                    render: data => data ? data.toLocaleString() + ' km' : '0 km'
                },
                {
                    data: null,
                    render: (data, type, row) => {
                        if (row.garantiaHasta) {
                            const fecha = new Date(row.garantiaHasta);
                            const hoy = new Date();
                            const vigente = fecha > hoy;
                            const color = vigente ? 'success' : 'danger';
                            const texto = vigente ? 'Vigente' : 'Vencida';
                            return `<span class="badge bg-${color}">${texto}</span> <small class="text-muted">${fecha.toLocaleDateString('es-HN', { day: '2-digit', month: '2-digit', year: 'numeric' })}</small>`;
                        }
                        return '<span class="text-muted">N/A</span>';
                    }
                },
                {
                    data: 'vehiculoId',
                    orderable: false,
                    className: 'text-center',
                    render: data => `
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info" onclick="abrirModalDetalle(${data})" title="Ver detalles">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-primary" onclick="abrirModalEditar(${data})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    `
                }
            ],
            language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json' },
            pageLength: 10,
            lengthMenu: [5, 10, 25, 50],
            order: [[3, 'desc']],
            responsive: true
        });

        $('#tablaFlota').removeClass('d-none');
    }

    function aplicarFiltros() {
        const clienteFiltro = $('#filtroCliente').val();
        let datos = [...datosOriginales];
        if (clienteFiltro) datos = datos.filter(v => v.clienteNombre === clienteFiltro);
        renderizarTabla(datos);
    }

    function limpiarFiltros() {
        $('#filtroCliente').val('').trigger('change.select2');
        renderizarTabla(datosOriginales);
    }

    function recargarTabla() {
        $.ajax({
            url: URLS.getAll,
            type: 'GET',
            success: function (response) {
                if (response.success && response.data) {
                    datosOriginales = response.data.filter(v => v.estado === ESTADO_ENTREGADO);
                    limpiarFiltros();
                }
            }
        });
    }

    // Modales
    function abrirModalDetalle(id) {
        AppModal.open({
            title: '<i class="fas fa-eye me-2"></i>Detalle del Vehículo',
            url: URLS.getDetail,
            data: { id: id },
            size: 'xl'
        });
    }

    function abrirModalEditar(id) {
        AppModal.open({
            title: '<i class="fas fa-pencil me-2"></i>Editar Vehículo',
            url: URLS.editPartial,
            data: { id: id },
            size: 'md'
        });
    }

    // CRUD
    function actualizarFlota() {
        const form = document.getElementById('formEditarFlota');
        const btn = document.getElementById('btnActualizarFlota');
        const btnOriginal = btn.innerHTML;

        if (!form.checkValidity()) { form.reportValidity(); return; }

        const data = {
            vehiculoId: parseInt($('#VehiculoId').val()),
            vin: $('#h_Vin').val(),
            placa: $('#h_Placa').val() || null,
            numeroMotor: $('#h_NumeroMotor').val() || null,
            numeroChasis: $('#h_NumeroChasis').val() || null,
            marcaId: parseInt($('#h_MarcaId').val()),
            modeloId: parseInt($('#h_ModeloId').val()),
            versionId: $('#h_VersionId').val() ? parseInt($('#h_VersionId').val()) : null,
            anio: parseInt($('#h_Anio').val()),
            color: $('#h_Color').val() || null,
            tipoCombustible: parseInt($('#h_TipoCombustible').val()),
            transmision: $('#h_Transmision').val() ? parseInt($('#h_Transmision').val()) : null,
            estado: parseInt($('#h_Estado').val()),
            sucursalId: $('#h_SucursalId').val() ? parseInt($('#h_SucursalId').val()) : null,
            procedencia: parseInt($('#h_Procedencia').val()),
            numeroImportacion: $('#h_NumeroImportacion').val() || null,
            numeroPoliza: $('#h_NumeroPoliza').val() || null,
            fechaIngresoPais: $('#h_FechaIngresoPais').val() || null,
            fechaRecepcion: $('#h_FechaRecepcion').val() || null,
            costoImportacion: $('#h_CostoImportacion').val() ? parseFloat($('#h_CostoImportacion').val()) : null,
            precioLista: $('#h_PrecioLista').val() ? parseFloat($('#h_PrecioLista').val()) : null,
            kilometrajeActual: parseInt($('#KilometrajeActual').val()) || 0,
            fechaPrimeraMatricula: $('#FechaPrimeraMatricula').val() || null,
            clienteId: $('#h_ClienteId').val() ? parseInt($('#h_ClienteId').val()) : null,
            precioVenta: $('#h_PrecioVenta').val() ? parseFloat($('#h_PrecioVenta').val()) : null,
            fechaVenta: $('#h_FechaVenta').val() || null,
            fechaEntrega: $('#h_FechaEntrega').val() || null,
            vendedorId: $('#h_VendedorId').val() || null,
            garantiaHasta: $('#GarantiaHasta').val() || null,
            observaciones: $('#Observaciones').val()?.trim() || null
        };

        $.ajax({
            url: URLS.edit,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            beforeSend: () => $(btn).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Actualizando...'),
            success: function (response) {
                if (response.success) {
                    AppModal.close();
                    recargarTabla();
                    Toast.success(response.message || 'Datos actualizados');
                } else {
                    Toast.error(response.message || 'Error al actualizar');
                }
            },
            error: function (xhr) {
                Toast.error(xhr.responseJSON?.message || 'Error al actualizar');
            },
            complete: () => $(btn).prop('disabled', false).html(btnOriginal)
        });
    }
</script>
}
