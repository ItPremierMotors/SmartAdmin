@model SmartAdmin.Models.Vehiculo.VehiculoDetalleViewModel

@{
}

<!-- Encabezado -->
<div class="d-flex align-items-center justify-content-between mb-3">
    <div>
        <h5 class="mb-0">@Model.DescripcionCompleta</h5>
        <small class="text-muted">@Model.Identificador</small>
    </div>
    <span class="badge bg-dark fs-6">Entregado</span>
</div>

<!-- Propietario y Entrega -->
<div class="card mb-3 border-primary">
    <div class="card-header bg-primary text-white">
        <h6 class="mb-0"><i class="fas fa-user me-2"></i>Propietario y Entrega</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <table class="table table-borderless table-sm mb-0">
                    <tr>
                        <td class="text-muted fw-bold" style="width:40%">Cliente:</td>
                        <td><strong>@(Model.ClienteNombre ?? "Sin asignar")</strong></td>
                    </tr>
                    @if (Model.FechaVenta.HasValue)
                    {
                        <tr>
                            <td class="text-muted fw-bold">Fecha Venta:</td>
                            <td>@Model.FechaVenta.Value.ToString("dd/MM/yyyy")</td>
                        </tr>
                    }
                    @if (Model.FechaEntrega.HasValue)
                    {
                        <tr>
                            <td class="text-muted fw-bold">Fecha Entrega:</td>
                            <td>@Model.FechaEntrega.Value.ToString("dd/MM/yyyy")</td>
                        </tr>
                    }
                </table>
            </div>
            <div class="col-md-6">
                <table class="table table-borderless table-sm mb-0">
                    @if (Model.PrecioVenta.HasValue)
                    {
                        <tr>
                            <td class="text-muted fw-bold" style="width:40%">Precio Venta:</td>
                            <td>$ @Model.PrecioVenta.Value.ToString("N2")</td>
                        </tr>
                    }
                    @if (!string.IsNullOrEmpty(Model.VendedorNombre))
                    {
                        <tr>
                            <td class="text-muted fw-bold">Vendedor:</td>
                            <td>@Model.VendedorNombre</td>
                        </tr>
                    }
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Garantía y Taller -->
<div class="card mb-3 border-warning">
    <div class="card-header bg-warning bg-opacity-25">
        <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Garantía y Servicio</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <table class="table table-borderless table-sm mb-0">
                    @if (Model.GarantiaHasta.HasValue)
                    {
                        <tr>
                            <td class="text-muted fw-bold" style="width:40%">Garantía Hasta:</td>
                            <td>
                                @Model.GarantiaHasta.Value.ToString("dd/MM/yyyy")
                                @if (Model.EnGarantia)
                                {
                                    <span class="badge bg-success ms-1">Vigente</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger ms-1">Vencida</span>
                                }
                            </td>
                        </tr>
                    }
                    <tr>
                        <td class="text-muted fw-bold">Servicios:</td>
                        <td>@Model.CantidadServicios</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <table class="table table-borderless table-sm mb-0">
                    <tr>
                        <td class="text-muted fw-bold" style="width:40%">Kilometraje:</td>
                        <td>
                            <span id="kmDisplay">@Model.KilometrajeActual.ToString("N0") km</span>
                            <button class="btn btn-sm btn-outline-secondary ms-2" id="btnEditarKm" onclick="toggleEditarKm()">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <span id="kmEditor" class="d-none">
                                <div class="input-group input-group-sm d-inline-flex" style="width:auto;">
                                    <input type="number" class="form-control" id="nuevoKm" value="@Model.KilometrajeActual" min="0" style="width:120px;" />
                                    <button class="btn btn-success" onclick="actualizarKilometraje(@Model.VehiculoId)"><i class="fas fa-check"></i></button>
                                    <button class="btn btn-secondary" onclick="cancelarEditarKm()"><i class="fas fa-times"></i></button>
                                </div>
                            </span>
                        </td>
                    </tr>
                    @if (Model.FechaPrimeraMatricula.HasValue)
                    {
                        <tr>
                            <td class="text-muted fw-bold">Primera Matrícula:</td>
                            <td>@Model.FechaPrimeraMatricula.Value.ToString("dd/MM/yyyy")</td>
                        </tr>
                    }
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Vehículo (info condensada) -->
<div class="card mb-3">
    <div class="card-header bg-light">
        <h6 class="mb-0"><i class="fas fa-car me-2"></i>Vehículo</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <table class="table table-borderless table-sm mb-0">
                    <tr>
                        <td class="text-muted fw-bold" style="width:40%">VIN:</td>
                        <td>@Model.Vin</td>
                    </tr>
                    @if (!string.IsNullOrEmpty(Model.Placa))
                    {
                        <tr>
                            <td class="text-muted fw-bold">Placa:</td>
                            <td>@Model.Placa</td>
                        </tr>
                    }
                    <tr>
                        <td class="text-muted fw-bold">Marca:</td>
                        <td>@Model.MarcaNombre</td>
                    </tr>
                    <tr>
                        <td class="text-muted fw-bold">Modelo:</td>
                        <td>@Model.ModeloNombre</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <table class="table table-borderless table-sm mb-0">
                    @if (!string.IsNullOrEmpty(Model.VersionNombre))
                    {
                        <tr>
                            <td class="text-muted fw-bold" style="width:40%">Versión:</td>
                            <td>@Model.VersionNombre</td>
                        </tr>
                    }
                    <tr>
                        <td class="text-muted fw-bold">Año:</td>
                        <td>@Model.Anio</td>
                    </tr>
                    @if (!string.IsNullOrEmpty(Model.Color))
                    {
                        <tr>
                            <td class="text-muted fw-bold">Color:</td>
                            <td>@Model.Color</td>
                        </tr>
                    }
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Observaciones -->
@if (!string.IsNullOrEmpty(Model.Observaciones))
{
    <div class="card mb-3">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="fas fa-sticky-note me-2"></i>Observaciones</h6>
        </div>
        <div class="card-body">
            <p class="mb-0">@Model.Observaciones</p>
        </div>
    </div>
}

<!-- Registro -->
<div class="text-muted small text-end">
    Registrado: @Model.FechaRegistro.ToString("dd/MM/yyyy HH:mm")
</div>

<div class="d-flex justify-content-end mt-4 pt-3 border-top">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="fas fa-times me-1"></i> Cerrar
    </button>
</div>

<script>
    function toggleEditarKm() {
        $('#kmDisplay, #btnEditarKm').addClass('d-none');
        $('#kmEditor').removeClass('d-none');
    }

    function cancelarEditarKm() {
        $('#kmEditor').addClass('d-none');
        $('#kmDisplay, #btnEditarKm').removeClass('d-none');
    }

    function actualizarKilometraje(vehiculoId) {
        const nuevoKm = parseInt($('#nuevoKm').val());
        if (isNaN(nuevoKm) || nuevoKm < 0) {
            Toast.error('Ingrese un kilometraje válido');
            return;
        }
        $.ajax({
            url: '@Url.Action("ActualizarKilometraje", "Flota")',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ vehiculoId: vehiculoId, nuevoKilometraje: nuevoKm }),
            success: function (response) {
                if (response.success) {
                    $('#kmDisplay').text(nuevoKm.toLocaleString() + ' km');
                    cancelarEditarKm();
                    Toast.success('Kilometraje actualizado');
                } else {
                    Toast.error(response.message || 'Error al actualizar');
                }
            },
            error: function (xhr) {
                Toast.error(xhr.responseJSON?.message || 'Error al actualizar');
            }
        });
    }
</script>
